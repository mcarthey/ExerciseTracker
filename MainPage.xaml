<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:model="clr-namespace:ExerciseTracker.Models"
    xmlns:controls="clr-namespace:ExerciseTracker.Controls"
    x:Class="ExerciseTracker.MainPage">

    <Grid>

        <!-- Define two rows: 
             1) Auto height for the header
             2) * to fill the rest of the space for the exercises list -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- BLUE HEADER (Row 0) -->
        <Grid x:Name="BlueHeader"
              Grid.Row="0"
              BackgroundColor="DarkBlue"
              Padding="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Program Details on the left -->
            <VerticalStackLayout Grid.Column="0" Spacing="2">
                <Label Text="{Binding TodayProgram.Split}"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="White" />
                <Label Text="{Binding TodayProgram.Notes}"
                       FontSize="16"
                       TextColor="White" />
            </VerticalStackLayout>

            <!-- Date icon on the right (tap to open HiddenDatePicker) -->
            <HorizontalStackLayout Grid.Column="1"
                                   Spacing="10"
                                   VerticalOptions="Center">
                <Border BackgroundColor="White"
                        Padding="5"
                        WidthRequest="60"
                        HeightRequest="60"
                        VerticalOptions="Center">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>

                    <!-- Border.GestureRecognizers -->
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding OpenDatePickerCommand}" />
                    </Border.GestureRecognizers>

                    <!-- The SINGLE child of this Border is a Grid that holds 
                           both your labels and the hidden DatePicker. -->
                    <Grid>
                        <VerticalStackLayout Spacing="0"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center">
                            <Label Text="{Binding SelectedDate, StringFormat='{0:ddd}'}"
                               FontSize="16"
                               TextColor="DarkBlue"
                               HorizontalTextAlignment="Center" />
                            <Label Text="{Binding SelectedDate, StringFormat='{0:dd}'}"
                               FontSize="16"
                               TextColor="DarkBlue"
                               HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>

                        <!-- Hidden DatePicker -->
                        <DatePicker x:Name="HiddenDatePicker"
                                    IsVisible="False"
                                    InputTransparent="True"
                                    Format="d"
                                    TextColor="Transparent"
                                    Unfocused="HiddenDatePicker_Unfocused"
                                    Date="{Binding SelectedDate}"
                                    VerticalOptions="Center"
                                    HorizontalOptions="Center"/>
                    </Grid>
                </Border>
            </HorizontalStackLayout>
        </Grid>

        <!-- EXERCISES LIST (Row 1) 
             The CollectionView scrolls by default, so no ScrollView is needed. -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding TodayExerciseSets}">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" Span="1"/>
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Padding="10"
                            Margin="5"
                            StrokeThickness="1"
                            Stroke="LightGray">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10"/>
                        </Border.StrokeShape>
                        <HorizontalStackLayout Spacing="15">
                            <!-- Exercise Image -->
                            <Border Padding="0" StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <Image Source="{Binding Exercise.Icon}"
                                       HeightRequest="80"
                                       WidthRequest="80"
                                       Aspect="AspectFill"/>
                            </Border>
                            <!-- Exercise Details -->
                            <VerticalStackLayout>
                                <Label Text="{Binding Exercise.Name}"
                                       FontSize="18"
                                       FontAttributes="Bold"/>
                                <Label Text="{Binding Exercise.MuscleGroup, StringFormat='Muscle Group: {0}'}"
                                       FontSize="16"
                                       TextColor="Gray"/>
                                <Label Text="{Binding SetType, StringFormat='Type: {0}'}"
                                       FontSize="16"/>
                                <Label Text="{Binding Sets, StringFormat='Sets: {0}'}"
                                       FontSize="16"/>
                                <Label Text="{Binding RepsDisplay}"
                                       FontSize="16"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- SEARCH OVERLAY (initially hidden).
             Span both rows so it overlays the entire page when visible. -->
        <Grid x:Name="SearchOverlay"
              Grid.RowSpan="2"
              BackgroundColor="#CCFFFFFF"
              IsVisible="False"
              VerticalOptions="Start"
              Padding="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Top bar with hamburger icon and search bar -->
            <HorizontalStackLayout>
                <!-- Hamburger Icon -->
                <Image Source="hamburger.png"
                       WidthRequest="30"
                       HeightRequest="30">
                    <Image.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding OpenFlyoutCommand}" />
                    </Image.GestureRecognizers>
                </Image>

                <!-- Search Bar -->
                <SearchBar x:Name="ProgramSearchBar"
                           Placeholder="Search Programs"
                           HorizontalOptions="FillAndExpand"
                           TextChanged="ProgramSearchBar_TextChanged"
                           SearchButtonPressed="ProgramSearchBar_SearchButtonPressed" />

                <!-- Cancel Button -->
                <Button Text="Cancel" Clicked="CancelSearch_Clicked" />
            </HorizontalStackLayout>

            <!-- Live search results (Row 1) -->
            <CollectionView x:Name="SearchResultsCollection"
                            Grid.Row="1"
                            ItemsSource="{Binding FilteredPrograms}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <!-- Replace Frame with Border -->
                        <Border Padding="10"
                                Margin="5"
                                StrokeThickness="1"
                                Stroke="LightGray">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout>
                                <Label Text="{Binding Split}"
                                       FontAttributes="Bold" />
                                <Label Text="{Binding Notes}" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Grid>
</ContentPage>
